/**
 * This code was AUTOGENERATED using the Codama library.
 * Please DO NOT EDIT THIS FILE, instead use visitors
 * to add features, then rerun Codama to update it.
 *
 * @see https://github.com/codama-idl/codama
 */

'use client';

import {
    appendTransactionMessageInstruction,
    createTransactionMessage,
    getSignatureFromTransaction,
    pipe,
    sendAndConfirmTransactionFactory,
    setTransactionMessageFeePayerSigner,
    setTransactionMessageLifetimeUsingBlockhash,
    signTransactionMessageWithSigners,
    type Rpc,
    type RpcSubscriptions,
    type Signature,
    type SolanaRpcApi,
    type SolanaRpcSubscriptionsApi,
    type TransactionSigner,
} from '@solana/kit';
import { useCallback, useState } from 'react';
import { getIncrementInstruction, type IncrementInput } from '../../';

type useIncrementConfig = {
    rpc: Rpc<SolanaRpcApi>;
    rpcSubscriptions: RpcSubscriptions<SolanaRpcSubscriptionsApi>;
    signer: TransactionSigner;
};

export function useIncrement(config: useIncrementConfig) {
    const [status, setStatus] = useState<'idle' | 'sending' | 'confirming' | 'success' | 'error'>('idle');
    const [error, setError] = useState<Error | null>(null);
    const [signature, setSignature] = useState<Signature | null>(null);

    const send = useCallback(
        async (input: IncrementInput) => {
            setStatus('sending');
            setError(null);
            setSignature(null);
            try {
                const instruction = getIncrementInstruction(input);
                const { value: latestBlockhash } = await config.rpc.getLatestBlockhash().send();
                const transactionMessage = pipe(
                    createTransactionMessage({ version: 0 }),
                    tx => setTransactionMessageFeePayerSigner(config.signer, tx),
                    tx => setTransactionMessageLifetimeUsingBlockhash(latestBlockhash, tx),
                    tx => appendTransactionMessageInstruction(instruction, tx),
                );
                const signedTransaction = await signTransactionMessageWithSigners(transactionMessage);
                setStatus('confirming');
                const txSignature = getSignatureFromTransaction(signedTransaction);
                setSignature(txSignature);
                const sendAndConfirm = sendAndConfirmTransactionFactory({
                    rpc: config.rpc,
                    rpcSubscriptions: config.rpcSubscriptions,
                });
                await sendAndConfirm(signedTransaction as Parameters<typeof sendAndConfirm>[0], {
                    commitment: 'confirmed',
                });
                setStatus('success');
            } catch (e) {
                setError(e instanceof Error ? e : new Error(String(e)));
                setStatus('error');
            }
        },
        [config.rpc, config.rpcSubscriptions, config.signer],
    );

    return { error, send, signature, status };
}
